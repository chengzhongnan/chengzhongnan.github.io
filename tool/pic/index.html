<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨èƒ½å›¾ç‰‡/Base64 è½¬æ¢å·¥å…· (æ”¯æŒå¤§å›¾é¢„è§ˆ)</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-color: #ddd;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        h2 { margin-top: 0; text-align: center; color: #444; margin-bottom: 20px; }

        /* è¾“å…¥åŒºåŸŸæ ·å¼ */
        .input-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        textarea.source-input {
            width: 100%;
            height: 100px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        textarea.source-input:focus { outline: none; border-color: var(--primary-color); }

        .file-upload-row { display: flex; align-items: center; gap: 15px; }

        .divider {
            display: flex; align-items: center; text-align: center; color: #999; font-size: 0.9em; margin: 5px 0;
        }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #eee; }
        .divider:not(:empty)::before { margin-right: .5em; }
        .divider:not(:empty)::after { margin-left: .5em; }

        /* æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 14px; }
        .btn-primary { background-color: var(--primary-color); color: white; flex: 2; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-file { background-color: #17a2b8; color: white; position: relative; overflow: hidden; }
        .btn-file input[type=file] { position: absolute; top: 0; right: 0; min-width: 100%; min-height: 100%; font-size: 100px; text-align: right; filter: alpha(opacity=0); opacity: 0; outline: none; background: white; cursor: inherit; display: block; }
        .btn-file:hover { background-color: #138496; }
        .btn-clear { background-color: var(--secondary-color); color: white; }
        .btn-clear:hover { background-color: #545b62; }

        /* é”™è¯¯æç¤º */
        .msg-box { padding: 12px; border-radius: 6px; margin-bottom: 20px; display: none; font-size: 14px; line-height: 1.5; }
        .msg-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .msg-warn { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* ç»“æœæ˜¾ç¤ºåŒºåŸŸ */
        #result-area { display: none; border-top: 2px dashed #eee; padding-top: 25px; animation: slideDown 0.4s ease-out; }
        .result-grid { display: grid; grid-template-columns: 1fr 300px; gap: 25px; }
        @media (max-width: 768px) { .result-grid { grid-template-columns: 1fr; } }

        /* å›¾ç‰‡é¢„è§ˆå®¹å™¨ - å¢åŠ æ”¾å¤§æç¤º */
        .preview-box {
            background: repeating-conic-gradient(#f9f9f9 0% 25%, transparent 0% 50%) 50% / 20px 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            display: flex; align-items: center; justify-content: center;
            min-height: 200px; max-height: 500px; overflow: hidden;
            position: relative;
        }

        /* é¢„è§ˆå›¾ç‰‡æœ¬èº«æ ·å¼ - å¢åŠ å¯ç‚¹å‡»æ‰‹åŠ¿ */
        img#preview-img {
            max-width: 100%;
            height: auto;
            display: block;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: zoom-in; /* é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ”¾å¤§é•œ */
            transition: transform 0.2s;
        }
        img#preview-img:hover {
            transform: scale(1.02);
        }

        /* å…ƒä¿¡æ¯åˆ—è¡¨ */
        .meta-list { background: #f8f9fa; border-radius: 8px; padding: 20px; }
        .meta-item { margin-bottom: 15px; border-bottom: 1px solid #e9ecef; padding-bottom: 10px; }
        .meta-item:last-child { border-bottom: none; }
        .meta-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px; }
        .meta-value { font-size: 15px; font-weight: 700; color: #333; word-break: break-all; }

        /* DataURL è¾“å‡ºæ¡† */
        .code-output-section { margin-top: 25px; }
        .code-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .code-header label { font-weight: bold; font-size: 14px; }
        textarea.code-output { width: 100%; height: 100px; padding: 10px; background: #2d2d2d; color: #66d9ef; border: 1px solid #444; border-radius: 6px; font-family: Consolas, monospace; font-size: 12px; resize: none; box-sizing: border-box; }
        .btn-copy { padding: 4px 12px; font-size: 12px; background: #e2e6ea; color: #333; }
        .btn-copy:hover { background: #dbe0e5; }
        .btn-download { display: block; width: 100%; text-align: center; background-color: var(--success-color); color: white; text-decoration: none; padding: 12px 0; border-radius: 6px; font-weight: bold; margin-top: 20px; }
        .btn-download:hover { background-color: #218838; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           Modal (å¤§å›¾é¢„è§ˆå±‚) æ ·å¼
        ========================================= */
        .modal {
            display: none; /* é»˜è®¤éšè— */
            position: fixed; 
            z-index: 1000; /* ç½®äºé¡¶å±‚ */
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            background-color: rgba(0,0,0,0.85); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            
            /* ä½¿ç”¨ Flex å¸ƒå±€å±…ä¸­æ˜¾ç¤ºå›¾ç‰‡ */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            animation: fadeIn 0.3s;
            backdrop-filter: blur(5px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
        }

        /* Modal ä¸­çš„å›¾ç‰‡å®¹å™¨ */
        .modal-content {
            max-width: 95vw; /* æœ€å¤§å®½åº¦ä¸ºè§†å£å®½åº¦çš„ 95% */
            max-height: 95vh; /* æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„ 95% */
            object-fit: contain; /* å…³é”®ï¼šä¿æŒå›¾ç‰‡åŸå§‹æ¯”ä¾‹ï¼Œä¸æ‹‰ä¼¸ */
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
            border-radius: 4px;
            animation: zoomIn 0.3s ease-out;
        }

        /* å…³é—­æŒ‰é’® (X) */
        .close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            z-index: 1001;
            cursor: pointer;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            transform: scale(1.1);
        }
        
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes zoomIn { from {transform: scale(0.9)} to {transform: scale(1)} }

    </style>
</head>
<body>

<div class="container">
    <h2>å…¨èƒ½å›¾ç‰‡è§£æå·¥å…·</h2>
    
    <div class="input-section">
        <textarea id="data-input" class="source-input" placeholder="ç²˜è´´ Data URLã€Base64 å­—ç¬¦ä¸²ï¼Œæˆ–è€…ä»¥ http/https å¼€å¤´çš„å›¾ç‰‡é“¾æ¥..."></textarea>
        
        <div class="divider">æˆ–è€…</div>

        <div class="file-upload-row">
            <button class="btn-file">
                ğŸ“ é€‰æ‹©æœ¬åœ°å›¾ç‰‡æ–‡ä»¶
                <input type="file" id="file-input" accept="image/*">
            </button>
            <span id="file-name-display" style="color:#666; font-size:14px;"></span>
        </div>

        <div class="btn-group">
            <button class="btn-primary" onclick="processInput()">è§£æå¹¶æ˜¾ç¤º</button>
            <button class="btn-clear" onclick="clearAll()">æ¸…ç©º</button>
        </div>
    </div>

    <div id="msg-box" class="msg-box"></div>

    <div id="result-area">
        <div class="result-grid">
            <div class="preview-box" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾">
                <img id="preview-img" alt="å›¾ç‰‡é¢„è§ˆ">
            </div>

            <div class="meta-list">
                <div class="meta-item">
                    <span class="meta-label">MIME ç±»å‹</span>
                    <span class="meta-value" id="meta-type">-</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">åŸå§‹å°ºå¯¸</span>
                    <span class="meta-value" id="meta-dims">-</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">æ–‡ä»¶å¤§å° (ä¼°ç®—)</span>
                    <span class="meta-value" id="meta-size">-</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">æ•°æ®æ¥æº</span>
                    <span class="meta-value" id="meta-source">-</span>
                </div>

                <a id="download-link" class="btn-download" href="#" download="image.png">ä¸‹è½½å›¾ç‰‡</a>
            </div>
        </div>

        <div class="code-output-section">
            <div class="code-header">
                <label>DataURL (Base64)</label>
                <button class="btn-copy" onclick="copyDataUrl()">å¤åˆ¶ DataURL</button>
            </div>
            <textarea id="dataurl-output" class="code-output" readonly></textarea>
        </div>
    </div>
</div>

<div id="imageModal" class="modal">
  <span class="close" onclick="closeModal()">&times;</span>
  <img class="modal-content" id="modal-image">
</div>

<script>
    // --- æ ¸å¿ƒå˜é‡ ---
    const textInput = document.getElementById('data-input');
    const fileInput = document.getElementById('file-input');
    const fileNameDisplay = document.getElementById('file-name-display');
    const resultArea = document.getElementById('result-area');
    const msgBox = document.getElementById('msg-box');
    const previewImg = document.getElementById('preview-img');
    const dataUrlOutput = document.getElementById('dataurl-output');
    const downloadLink = document.getElementById('download-link');
    
    // --- Modal ç›¸å…³å˜é‡ ---
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById("modal-image");

    // --- äº‹ä»¶ç›‘å¬ ---

    // æ–‡ä»¶é€‰æ‹©ç›‘å¬
    fileInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
            fileNameDisplay.textContent = this.files[0].name;
            processInput();
        }
    });

    // **å…³é”®æ–°å¢ï¼šç‚¹å‡»é¢„è§ˆå›¾ï¼Œæ‰“å¼€ Modal**
    previewImg.addEventListener('click', function() {
        // åªæœ‰å½“å›¾ç‰‡æœ‰ src æ—¶æ‰æ‰“å¼€
        if(this.src && this.src !== window.location.href) {
            modal.style.display = "flex"; // ä½¿ç”¨ flex å¸ƒå±€å±…ä¸­
            modalImg.src = this.src;
        }
    });

    // ç‚¹å‡» Modal èƒŒæ™¯å…³é—­
    modal.addEventListener('click', function(e) {
        // å¦‚æœç‚¹å‡»çš„æ˜¯èƒŒæ™¯å±‚ï¼ˆä¸æ˜¯å›¾ç‰‡æœ¬èº«ï¼‰ï¼Œåˆ™å…³é—­
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // æŒ‰ ESC é”®å…³é—­ Modal
    document.addEventListener('keydown', function(e) {
        if(e.key === "Escape" && modal.style.display === "flex") {
             closeModal();
        }
    });

    function closeModal() {
        modal.style.display = "none";
        modalImg.src = ""; // æ¸…ç©ºèµ„æº
    }

    // --- ä¸šåŠ¡é€»è¾‘å‡½æ•° ---

    async function processInput() {
        hideMsg();
        if (fileInput.files && fileInput.files[0]) {
            processFile(fileInput.files[0]);
            return;
        }
        let rawStr = textInput.value.trim();
        if (!rawStr) {
            showMsg("è¯·è¾“å…¥ DataURLã€URL é“¾æ¥æˆ–é€‰æ‹©æ–‡ä»¶ã€‚", "error");
            return;
        }
        let cleanStr = rawStr.replace(/^["']|["']$/g, '').trim();
        if (cleanStr.match(/^https?:\/\//i)) {
            processNetworkUrl(cleanStr);
        } else {
            processBase64(cleanStr);
        }
    }

    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => renderResult(e.target.result, "æœ¬åœ°æ–‡ä»¶");
        reader.onerror = () => showMsg("è¯»å–æ–‡ä»¶å¤±è´¥", "error");
        reader.readAsDataURL(file);
    }

    function processBase64(str) {
        if (!str.startsWith('data:')) str = detectAndFixHeader(str);
        renderResult(str, "Base64 æ–‡æœ¬");
    }

    function processNetworkUrl(url) {
        showMsg("æ­£åœ¨å°è¯•è·å–ç½‘ç»œå›¾ç‰‡...", "warn");
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = function() {
            hideMsg();
            try {
                const canvas = document.createElement('canvas');
                canvas.width = this.naturalWidth;
                canvas.height = this.naturalHeight;
                canvas.getContext('2d').drawImage(this, 0, 0);
                renderResult(canvas.toDataURL('image/png'), "ç½‘ç»œ URL (å·²è½¬ Base64)");
            } catch (e) {
                renderResultOnlyDisplay(url, "ç½‘ç»œ URL (CORS å—é™)");
                showMsg("æ³¨æ„ï¼šCORS é™åˆ¶ã€‚æ— æ³•ç”Ÿæˆ DataURLï¼Œä»…ä¾›é¢„è§ˆã€‚", "warn");
            }
        };
        img.onerror = () => showMsg("æ— æ³•åŠ è½½è¯¥ URLã€‚", "error");
        img.src = url;
    }

    function renderResult(dataUrl, sourceLabel) {
        previewImg.src = dataUrl;
        dataUrlOutput.value = dataUrl;
        downloadLink.href = dataUrl;
        downloadLink.download = `image_${new Date().getTime()}.png`;
        downloadLink.textContent = "ä¸‹è½½å›¾ç‰‡";
        updateMetadata(dataUrl, sourceLabel);
        resultArea.style.display = 'block';
        setTimeout(() => resultArea.scrollIntoView({behavior: 'smooth'}), 100);
    }

    function renderResultOnlyDisplay(url, sourceLabel) {
        previewImg.src = url;
        dataUrlOutput.value = "æ— æ³•è·å– DataURL (å— CORS ç­–ç•¥ä¿æŠ¤)";
        downloadLink.href = url;
        downloadLink.target = "_blank";
        downloadLink.textContent = "åœ¨æ–°çª—å£æ‰“å¼€åŸå›¾";
        document.getElementById('meta-source').textContent = sourceLabel;
        document.getElementById('meta-type').textContent = "Remote Image";
        document.getElementById('meta-size').textContent = "æœªçŸ¥";
        // éœ€è¦ç­‰å›¾ç‰‡åŠ è½½å®Œæ‰èƒ½è·å–å°ºå¯¸ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾å®ƒå·²ç»åŠ è½½
        setTimeout(() => {
             document.getElementById('meta-dims').textContent = `${previewImg.naturalWidth} x ${previewImg.naturalHeight} px`;
        }, 100);
        resultArea.style.display = 'block';
    }

    function updateMetadata(dataUrl, source) {
        // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM æ›´æ–°
        setTimeout(() => {
            document.getElementById('meta-dims').textContent = `${previewImg.naturalWidth} x ${previewImg.naturalHeight} px`;
        }, 50);
        let mime = "Unknown";
        const match = dataUrl.match(/^data:(.*?);base64,/);
        if (match) mime = match[1];
        document.getElementById('meta-type').textContent = mime;
        document.getElementById('meta-source').textContent = source;
        document.getElementById('meta-size').textContent = calculateBase64Size(dataUrl);
    }

    function detectAndFixHeader(base64Str) {
        const str = base64Str.trim();
        if (str.startsWith('/9j/')) return 'data:image/jpeg;base64,' + str;
        if (str.startsWith('iVBORw0KGgo')) return 'data:image/png;base64,' + str;
        if (str.startsWith('R0lGOD')) return 'data:image/gif;base64,' + str;
        if (str.startsWith('UklGR')) return 'data:image/webp;base64,' + str;
        return 'data:image/png;base64,' + str;
    }

    function calculateBase64Size(dataUrl) {
        if (!dataUrl.startsWith('data')) return "æœªçŸ¥";
        const content = dataUrl.split(',')[1] || "";
        const sizeInBytes = (content.length * 0.75) - (content.match(/=/g) || []).length;
        if (sizeInBytes < 1024) return sizeInBytes.toFixed(0) + ' B';
        if (sizeInBytes < 1024*1024) return (sizeInBytes / 1024).toFixed(2) + ' KB';
        return (sizeInBytes / (1024*1024)).toFixed(2) + ' MB';
    }

    function copyDataUrl() {
        dataUrlOutput.select();
        document.execCommand('copy');
        const btn = document.querySelector('.btn-copy');
        const originalText = btn.textContent;
        btn.textContent = "å·²å¤åˆ¶ï¼";
        setTimeout(() => btn.textContent = originalText, 1500);
    }

    function showMsg(text, type) {
        msgBox.textContent = text;
        msgBox.className = 'msg-box ' + (type === 'error' ? 'msg-error' : 'msg-warn');
        msgBox.style.display = 'block';
    }

    function hideMsg() { msgBox.style.display = 'none'; }

    function clearAll() {
        textInput.value = '';
        fileInput.value = '';
        fileNameDisplay.textContent = '';
        resultArea.style.display = 'none';
        previewImg.src = ""; // æ¸…ç©ºå›¾ç‰‡ç¼“å­˜
        hideMsg();
    }
</script>

</body>
</html>