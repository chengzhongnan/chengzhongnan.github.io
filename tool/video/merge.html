<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¯HTMLè§†é¢‘åˆå¹¶å·¥å…· (ffmpeg.wasm)</title>
    <style>
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 30px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 { margin-top: 0; color: #2c3e50; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #2980b9; }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .step-block {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
        }
        .status-ready { color: #27ae60; font-weight: bold; margin-left: 10px; }
        input[type="file"] {
            padding: 10px;
            border: 1px dashed #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        /* Loading Spinner */
        .loading-container {
            display: none; /* é»˜è®¤éšè— */
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Logs and Result */
        .log-container {
            margin-top: 20px;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        #logContent { white-space: pre-wrap; word-break: break-all; margin: 0; }
        #resultArea { display: none; margin-top: 20px; text-align: center; }
        video { max-width: 100%; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .download-btn { display: inline-block; margin-top: 15px; text-decoration: none; background: #27ae60; padding: 10px 20px; color: white; border-radius: 4px;}
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“º çº¯HTMLè§†é¢‘åˆå¹¶å·¥å…· (ffmpeg.wasm)</h1>
    <p style="color: #666;">æ³¨æ„ï¼šæ­¤æ–¹æ³•ä½¿ç”¨ "æµå¤åˆ¶" æ¨¡å¼ï¼Œè¦æ±‚æ‰€æœ‰è¾“å…¥è§†é¢‘å¿…é¡»å…·æœ‰<b>ç›¸åŒçš„åˆ†è¾¨ç‡ã€ç¼–ç æ ¼å¼å’Œå¸§ç‡</b>ï¼Œå¦åˆ™åˆå¹¶åçš„è§†é¢‘å¯èƒ½æ— æ³•æ’­æ”¾æˆ–èŠ±å±ã€‚</p>

    <div class="step-block" id="step1Container">
        <h3>ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–å¼•æ“</h3>
        <button id="loadBtn">ç‚¹å‡»åŠ è½½ FFmpeg æ ¸å¿ƒ (~30MB)</button>
        <span id="loadStatus"></span>
    </div>

    <div class="step-block" id="step2Container" style="opacity: 0.5; pointer-events: none;">
        <h3>ç¬¬äºŒæ­¥ï¼šé€‰æ‹©è§†é¢‘å¹¶åˆå¹¶</h3>
        <p>è¯·æŒ‰æœŸæœ›çš„æ’­æ”¾é¡ºåºé€‰æ‹©ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„æ–‡ä»¶ï¼ˆæŒ‰ä½ Ctrl æˆ– Shift å¤šé€‰ï¼‰ã€‚</p>
        <input type="file" id="fileInput" multiple accept="video/mp4,video/webm,video/mov">
        <br><br>
        <button id="mergeBtn" disabled>å¼€å§‹åˆå¹¶è§†é¢‘</button>
    </div>

    <div class="loading-container" id="loadingBox">
        <div class="spinner"></div>
        <p id="loadingText">æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·å‹¿å…³é—­é¡µé¢...</p>
    </div>

    <div id="resultArea" class="step-block" style="border-color: #27ae60;">
        <h3 style="color: #27ae60;">ğŸ‰ åˆå¹¶æˆåŠŸï¼</h3>
        <video id="outputVideo" controls></video>
        <br>
        <a id="downloadLink" class="download-btn" download="merged_video.mp4">â¬‡ï¸ ä¸‹è½½åˆå¹¶åçš„è§†é¢‘</a>
    </div>

    <div class="log-container">
        <div style="margin-bottom: 5px; font-weight: bold;">è¿è¡Œæ—¥å¿—:</div>
        <pre id="logContent"></pre>
    </div>
</div>


<script type="module">
    // ä» CDN å¯¼å…¥ FFmpeg ç±»å’Œå·¥å…·å‡½æ•°
    import { FFmpeg } from 'https://esm.sh/@ffmpeg/ffmpeg@0.12.10';
    import { fetchFile, toBlobURL } from 'https://esm.sh/@ffmpeg/util@0.12.1';

    // --- DOM å…ƒç´ å¼•ç”¨ ---
    const loadBtn = document.getElementById('loadBtn');
    const loadStatus = document.getElementById('loadStatus');
    const step2Container = document.getElementById('step2Container');
    const fileInput = document.getElementById('fileInput');
    const mergeBtn = document.getElementById('mergeBtn');
    const loadingBox = document.getElementById('loadingBox');
    const loadingText = document.getElementById('loadingText');
    const resultArea = document.getElementById('resultArea');
    const outputVideo = document.getElementById('outputVideo');
    const downloadLink = document.getElementById('downloadLink');
    const logContent = document.getElementById('logContent');

    let ffmpeg = null;
    let isCoreLoaded = false;

    // --- å·¥å…·å‡½æ•° ---
    
    // æ·»åŠ æ—¥å¿—åˆ°ç•Œé¢
    const addLog = (message) => {
        const time = new Date().toLocaleTimeString();
        logContent.textContent += `[${time}] ${message}\n`;
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;
    };

    // åˆ‡æ¢åŠ è½½çŠ¶æ€æ˜¾ç¤º
    const setLoadingState = (isLoading, text = "å¤„ç†ä¸­...") => {
        loadingBox.style.display = isLoading ? 'block' : 'none';
        loadingText.textContent = text;
        // ç¦ç”¨/å¯ç”¨äº¤äº’æŒ‰é’®
        fileInput.disabled = isLoading;
        mergeBtn.disabled = isLoading || fileInput.files.length < 2;
    };

    // --- æ ¸å¿ƒé€»è¾‘ ---

    // 1. åŠ è½½ FFmpeg æ ¸å¿ƒ (WASM æ–‡ä»¶)
    const loadFFmpegCore = async () => {
        if (isCoreLoaded) return;
        
        loadBtn.disabled = true;
        setLoadingState(true, "æ­£åœ¨ä¸‹è½½å¹¶åˆå§‹åŒ– WASM æ ¸å¿ƒï¼Œè¯·è€å¿ƒç­‰å¾…...");
        
        try {
            ffmpeg = new FFmpeg();
            // ç»‘å®šæ—¥å¿—å›è°ƒï¼ŒFFmpeg çš„å†…éƒ¨è¾“å‡ºä¼šæ‰“å°åœ¨è¿™é‡Œ
            ffmpeg.on('log', ({ message }) => {
               // è¿‡æ»¤æ‰ä¸€äº›å¤ªé¢‘ç¹çš„æ—¥å¿—ï¼Œåªä¿ç•™å…³é”®ä¿¡æ¯
               if(message.startsWith('frame=') || message.startsWith('size=')) return;
               addLog(`[FFmpeg] ${message}`);
            });

            addLog("å¼€å§‹åŠ è½½æ ¸å¿ƒ...");
            // ä½¿ç”¨ esm.sh çš„ CDN åœ°å€
            const baseURL = 'https://esm.sh/@ffmpeg/core@0.12.10/dist/umd';
            await ffmpeg.load({
                // ä½¿ç”¨ toBlobURL å¯ä»¥é¿å…ä¸€äº›è·¨åŸŸ (CORS) é—®é¢˜
                coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
            });

            isCoreLoaded = true;
            loadStatus.innerHTML = '<span class="status-ready">âœ… æ ¸å¿ƒåŠ è½½å®Œæˆï¼Œè¯·ç»§ç»­ä¸‹ä¸€æ­¥</span>';
            loadBtn.style.display = 'none'; // éšè—åŠ è½½æŒ‰é’®
            // æ¿€æ´»ç¬¬äºŒæ­¥åŒºåŸŸ
            step2Container.style.opacity = '1';
            step2Container.style.pointerEvents = 'auto';
            addLog("æ ¸å¿ƒåˆå§‹åŒ–æˆåŠŸï¼");

        } catch (error) {
            addLog(`âŒ åŠ è½½å¤±è´¥: ${error.message}`);
            alert("FFmpegæ ¸å¿ƒåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æŸ¥çœ‹ä¸‹æ–¹æ—¥å¿—ã€‚");
            loadBtn.disabled = false;
        } finally {
            setLoadingState(false);
        }
    };

    // 2. æ‰§è¡Œè§†é¢‘åˆå¹¶
    const startMerge = async () => {
        const files = fileInput.files;
        if (files.length < 2) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸¤ä¸ªè§†é¢‘æ–‡ä»¶è¿›è¡Œåˆå¹¶ã€‚");
            return;
        }

        setLoadingState(true, "æ­£åœ¨è¯»å–æ–‡ä»¶å¹¶æ‰§è¡Œåˆå¹¶ï¼Œè¯·ç¨å€™...");
        resultArea.style.display = 'none'; // éšè—æ—§çš„ç»“æœ
        
        // å¦‚æœä¹‹å‰æœ‰ç”Ÿæˆçš„è§†é¢‘URLï¼Œé‡Šæ”¾å†…å­˜
        if (outputVideo.src) {
            URL.revokeObjectURL(outputVideo.src);
            outputVideo.src = '';
        }

        try {
            addLog("--- å¼€å§‹æ–°çš„åˆå¹¶ä»»åŠ¡ ---");
            const inputNames = [];

            // A. å°†ç”¨æˆ·é€‰æ‹©çš„æ–‡ä»¶å†™å…¥ WASM çš„è™šæ‹Ÿå†…å­˜æ–‡ä»¶ç³»ç»Ÿ (MEMFS)
            addLog("æ­£åœ¨å°†æ–‡ä»¶å†™å…¥å†…å­˜æ–‡ä»¶ç³»ç»Ÿ...");
            for (let i = 0; i < files.length; i++) {
                // ä¸ºäº†å®‰å…¨å’Œç®€ä¾¿ï¼Œæˆ‘ä»¬å°†è¾“å…¥æ–‡ä»¶é‡å‘½åä¸º input_0.mp4, input_1.mp4 ç­‰
                // å‡è®¾è¾“å…¥éƒ½æ˜¯ mp4ï¼Œå®é™…ä¸Š ffmpeg å¯ä»¥è‡ªåŠ¨è¯†åˆ«ï¼Œä½†åç¼€åæœ‰åŠ©äºå®ƒåˆ¤æ–­
                const safeName = `input_${i}.mp4`; 
                addLog(`-> è¯»å–å¹¶å†™å…¥: ${files[i].name} é‡å‘½åä¸º ${safeName}`);
                // fetchFile å¯ä»¥å°† File å¯¹è±¡è½¬ä¸º Uint8Array
                const fileData = await fetchFile(files[i]);
                // å†™å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
                await ffmpeg.writeFile(safeName, fileData);
                inputNames.push(safeName);
            }

            // B. åˆ›å»º concat æ‰€éœ€çš„åˆ—è¡¨æ–‡ä»¶ (list.txt)
            // æ–‡ä»¶å†…å®¹æ ¼å¼ç±»ä¼¼äº: file 'input_0.mp4' \n file 'input_1.mp4'
            const listContent = inputNames.map(name => `file '${name}'`).join('\n');
            await ffmpeg.writeFile('concat_list.txt', listContent);
            addLog(`å·²åˆ›å»ºåˆå¹¶åˆ—è¡¨æ–‡ä»¶ (concat_list.txt)`);

            // C. æ‰§è¡Œ FFmpeg å‘½ä»¤
            // -f concat: ä½¿ç”¨æ‹¼æ¥è§£å¤ç”¨å™¨
            // -safe 0: å…è®¸è¯»å–ç›¸å¯¹è·¯å¾„
            // -i concat_list.txt: è¾“å…¥çš„åˆ—è¡¨æ–‡ä»¶
            // -c copy: æ ¸å¿ƒå‚æ•°ï¼è¡¨ç¤ºç›´æ¥å¤åˆ¶æµï¼Œä¸é‡æ–°ç¼–ç ã€‚é€Ÿåº¦æå¿«ï¼Œä½†è¦æ±‚æºæ–‡ä»¶å‚æ•°ä¸€è‡´ã€‚
            addLog("ğŸš€ æ­£åœ¨æ‰§è¡Œ FFmpeg åˆå¹¶å‘½ä»¤...");
            const command = ['-f', 'concat', '-safe', '0', '-i', 'concat_list.txt', '-c', 'copy', 'output.mp4'];
            addLog(`æ‰§è¡Œå‘½ä»¤: ffmpeg ${command.join(' ')}`);
            
            // exec æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œç­‰å¾…å®ƒå®Œæˆ
            await ffmpeg.exec(command);

            addLog("å‘½ä»¤æ‰§è¡Œå®Œæ¯•ï¼Œæ­£åœ¨è¯»å–è¾“å‡ºæ–‡ä»¶...");

            // D. è¯»å–è¾“å‡ºæ–‡ä»¶å¹¶ç”Ÿæˆæµè§ˆå™¨å¯ç”¨çš„ URL
            // readFile è¿”å›çš„æ˜¯ Uint8Array
            const data = await ffmpeg.readFile('output.mp4');
            // åˆ›å»º Blob
            const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
            // åˆ›å»º Object URL
            const videoUrl = URL.createObjectURL(videoBlob);

            // æ›´æ–° UI æ˜¾ç¤ºç»“æœ
            outputVideo.src = videoUrl;
            downloadLink.href = videoUrl;
            resultArea.style.display = 'block';
            addLog("âœ¨ åˆå¹¶æˆåŠŸï¼ç»“æœå·²æ˜¾ç¤ºåœ¨ä¸Šæ–¹ã€‚");

            // E. (å¯é€‰) æ¸…ç†å†…å­˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶
            addLog("æ¸…ç†ä¸´æ—¶æ–‡ä»¶...");
            await ffmpeg.deleteFile('concat_list.txt');
            // await ffmpeg.deleteFile('output.mp4'); // è¾“å‡ºæ–‡ä»¶å…ˆç•™ç€ï¼Œå¦‚æœç”¨æˆ·å†æ¬¡ç‚¹å‡»åˆå¹¶ä¼šè¦†ç›–
            for (const name of inputNames) {
                await ffmpeg.deleteFile(name);
            }

        } catch (error) {
            console.error(error);
            addLog(`âŒ åˆå¹¶è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`);
            alert(`åˆå¹¶å¤±è´¥ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1.è§†é¢‘æ–‡ä»¶çš„åˆ†è¾¨ç‡æˆ–ç¼–ç ä¸ä¸€è‡´ï¼ˆæµå¤åˆ¶æ¨¡å¼è¦æ±‚ä¸¥æ ¼ä¸€è‡´ï¼‰ã€‚\n2.æµè§ˆå™¨å†…å­˜ä¸è¶³ã€‚\n\nè¯·æŸ¥çœ‹ä¸‹æ–¹æ—¥å¿—è¯¦æƒ…ã€‚`);
        } finally {
            setLoadingState(false);
        }
    };

    // --- äº‹ä»¶ç›‘å¬ ---

    // ç‚¹å‡»åŠ è½½æŒ‰é’®
    loadBtn.addEventListener('click', loadFFmpegCore);

    // ç›‘å¬æ–‡ä»¶é€‰æ‹©å˜åŒ–ï¼Œå¯ç”¨/ç¦ç”¨åˆå¹¶æŒ‰é’®
    fileInput.addEventListener('change', () => {
        const count = fileInput.files.length;
        addLog(`å·²é€‰æ‹© ${count} ä¸ªæ–‡ä»¶`);
        mergeBtn.disabled = count < 2;
        if (count > 0 && count < 2) {
            addLog("æç¤º: éœ€è¦è‡³å°‘ä¸¤ä¸ªæ–‡ä»¶æ‰èƒ½åˆå¹¶ã€‚");
        }
    });

    // ç‚¹å‡»åˆå¹¶æŒ‰é’®
    mergeBtn.addEventListener('click', startMerge);

    addLog("å°±ç»ªã€‚è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½å¼•æ“ã€‚");

</script>

</body>
</html>