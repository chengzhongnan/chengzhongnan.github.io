<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°ç‰ˆè§†é¢‘åˆå¹¶å·¥å…· (ffmpeg.wasm)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 30px; background-color: #f5f5f5; max-width: 800px; margin: 0 auto; }
        .container { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        button { padding: 10px 20px; cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 4px; font-size: 16px; margin-right: 10px;}
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        input[type="file"] { margin: 15px 0; display: block; width: 100%; padding: 10px; border: 1px dashed #ccc; }
        .log-box { margin-top: 20px; background: #2c3e50; color: #ecf0f1; padding: 15px; height: 250px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; border-radius: 4px;}
        #resultArea { display: none; margin-top: 20px; text-align: center; border: 2px solid #27ae60; padding: 10px; border-radius: 4px;}
        video { max-width: 100%; margin-top: 10px; }
        .download-btn { display: inline-block; margin-top: 10px; text-decoration: none; background: #27ae60; padding: 8px 20px; color: white; border-radius: 4px;}
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“‚ æœ¬åœ°ç¦»çº¿ç‰ˆè§†é¢‘åˆå¹¶</h1>
    <p style="color: #666; font-size: 0.9em;">è¯·ç¡®ä¿ ffmpeg-core.wasm, ffmpeg-core.js, ffmpeg.mjs, util.mjs éƒ½åœ¨å½“å‰ç›®å½•ä¸‹ã€‚</p>

    <div id="step1">
        <button id="loadBtn">1. åŠ è½½æœ¬åœ°å¼•æ“</button>
        <span id="loadStatus">ğŸ”´ æœªåŠ è½½</span>
    </div>

    <div id="step2" style="opacity: 0.5; pointer-events: none; margin-top: 20px;">
        <h3>2. é€‰æ‹©è§†é¢‘å¹¶åˆå¹¶</h3>
        <input type="file" id="fileInput" multiple accept="video/*">
        <button id="mergeBtn" disabled>å¼€å§‹åˆå¹¶</button>
    </div>

    <div id="resultArea">
        <h3 style="color: #27ae60;">åˆå¹¶æˆåŠŸï¼</h3>
        <video id="outputVideo" controls></video><br>
        <a id="downloadLink" class="download-btn" download="merged_local.mp4">ä¸‹è½½è§†é¢‘</a>
    </div>

    <div class="log-box" id="logContent"></div>
</div>

<script type="module">
    // â¬‡ï¸ ä¿®æ”¹ç‚¹ 1ï¼šå¼•ç”¨æœ¬åœ°æ–‡ä»¶
    import { FFmpeg } from './ffmpeg.mjs';
    import { fetchFile, toBlobURL } from './util.mjs';

    const loadBtn = document.getElementById('loadBtn');
    const loadStatus = document.getElementById('loadStatus');
    const step2 = document.getElementById('step2');
    const fileInput = document.getElementById('fileInput');
    const mergeBtn = document.getElementById('mergeBtn');
    const logContent = document.getElementById('logContent');
    const resultArea = document.getElementById('resultArea');
    const outputVideo = document.getElementById('outputVideo');
    const downloadLink = document.getElementById('downloadLink');

    let ffmpeg = null;

    const addLog = (msg) => {
        logContent.textContent += `> ${msg}\n`;
        logContent.scrollTop = logContent.scrollHeight;
    };

    // --- åŠ è½½æ ¸å¿ƒ ---
    loadBtn.addEventListener('click', async () => {
        loadBtn.disabled = true;
        addLog("æ­£åœ¨åŠ è½½æœ¬åœ°æ ¸å¿ƒæ–‡ä»¶...");
        
        try {
            ffmpeg = new FFmpeg();
            
            ffmpeg.on('log', ({ message }) => {
                if(!message.includes('frame=')) addLog(message);
            });

            // â¬‡ï¸ ä¿®æ”¹ç‚¹ 2ï¼šæ˜¾å¼æŒ‡å‘æœ¬åœ°çš„ core.js å’Œ core.wasm
            // ä½¿ç”¨ toBlobURL å¯ä»¥è®©æµè§ˆå™¨è®¤ä¸ºæ–‡ä»¶æ˜¯åŒæºçš„ï¼Œé¿å…éƒ¨åˆ†è·¨åŸŸé—®é¢˜
            await ffmpeg.load({
                coreURL: await toBlobURL('./ffmpeg-core.js', 'text/javascript'),
                wasmURL: await toBlobURL('./ffmpeg-core.wasm', 'application/wasm'),
            });

            loadStatus.textContent = "âœ… å·²åŠ è½½";
            loadStatus.style.color = "green";
            loadBtn.style.display = 'none';
            step2.style.opacity = '1';
            step2.style.pointerEvents = 'auto';
            addLog("æ ¸å¿ƒåŠ è½½æˆåŠŸï¼å®Œå…¨è¿è¡Œåœ¨æœ¬åœ°æ¨¡å¼ã€‚");

        } catch (error) {
            console.error(error);
            addLog(`âŒ åŠ è½½å¤±è´¥: ${error.message}`);
            addLog("æç¤º: è¯·ç¡®ä¿ä½ æ­£åœ¨ä½¿ç”¨ http://localhost è®¿é—®æ­¤é¡µé¢ï¼Œè€Œä¸æ˜¯ file://");
            loadBtn.disabled = false;
        }
    });

    // --- ç›‘å¬æ–‡ä»¶é€‰æ‹© ---
    fileInput.addEventListener('change', () => {
        mergeBtn.disabled = fileInput.files.length < 2;
        addLog(`å·²é€‰æ‹© ${fileInput.files.length} ä¸ªæ–‡ä»¶`);
    });

    // --- æ‰§è¡Œåˆå¹¶ ---
    mergeBtn.addEventListener('click', async () => {
        if (fileInput.files.length < 2) return;
        
        mergeBtn.disabled = true;
        mergeBtn.textContent = "å¤„ç†ä¸­...";
        resultArea.style.display = 'none';
        
        try {
            const files = fileInput.files;
            const inputNames = [];

            // 1. å†™å…¥æ–‡ä»¶
            for (let i = 0; i < files.length; i++) {
                const safeName = `input_${i}.mp4`;
                addLog(`è¯»å–å¹¶å†™å…¥: ${safeName}`);
                await ffmpeg.writeFile(safeName, await fetchFile(files[i]));
                inputNames.push(safeName);
            }

            // 2. åˆ›å»ºåˆ—è¡¨
            const listContent = inputNames.map(name => `file '${name}'`).join('\n');
            await ffmpeg.writeFile('list.txt', listContent);

            // 3. è¿è¡Œå‘½ä»¤ (æµå¤åˆ¶)
            addLog("å¼€å§‹æ‰§è¡Œåˆå¹¶ (concat mode)...");
            await ffmpeg.exec(['-f', 'concat', '-safe', '0', '-i', 'list.txt', '-c', 'copy', 'output.mp4']);

            // 4. è¯»å–ç»“æœ
            addLog("è¯»å–è¾“å‡ºæ–‡ä»¶...");
            const data = await ffmpeg.readFile('output.mp4');
            const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));

            outputVideo.src = url;
            downloadLink.href = url;
            resultArea.style.display = 'block';
            addLog("âœ¨ å…¨éƒ¨å®Œæˆï¼");

            // æ¸…ç†
            await ffmpeg.deleteFile('list.txt');
            await ffmpeg.deleteFile('output.mp4');
            for (const name of inputNames) await ffmpeg.deleteFile(name);

        } catch (error) {
            addLog(`âŒ å‡ºé”™: ${error.message}`);
        } finally {
            mergeBtn.disabled = false;
            mergeBtn.textContent = "å¼€å§‹åˆå¹¶";
        }
    });
</script>

</body>
</html>